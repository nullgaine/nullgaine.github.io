<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>「箱」簡易接続装置</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #111; color: white; text-align: center; }
        #addendum { margin: 20px auto; width: 600px; min-height: 400px; } /* 高さを確保 */
        #chatbox { width: 100%; height: 300px; background: black; color: white; overflow-y: auto; padding: 10px; border: 1px solid white; text-align: left; }
        input[type="text"] { width: 80%; padding: 5px; background: #222; color: white; border: 1px solid #444; }
        button { padding: 5px 10px; cursor: pointer; }
        button:disabled { cursor: not-allowed; opacity: 0.5; }
    </style>
</head>
<body onload="init()">

    <h1>箱</h1>
    <div id="addendum">
        </div>

    <script>
        let responses = {};

        // 1. 最初に実行される
        async function init() {
            // UIを先に作ってしまう（箱が消えるのを防ぐ）
            setupChatUI();

            try {
                // 外部JSON読み込み
                const response = await fetch('responses.json');
                if (!response.ok) throw new Error('Network response was not ok');
                responses = await response.json();
            } catch (error) {
                console.error("辞書読み込み失敗。内蔵データを使用します:", error);
                // 読み込めなかった時のための最低限のバックアップ
                responses = { "こんにちは": "（通信が不安定なようだ……）" };
            }
            
            // プログレスバー開始
            startProgress();
        }

        // 2. チャットの見た目を作る
        function setupChatUI() {
            var chatroom = `
                <div id="chatbox">
                    <pre><span id="progressbar"></span><span id="chatlog"></span></pre>
                </div>
                <input type="text" id="chatInput" maxlength="30" placeholder="メッセージを入力">
                <button id="sendBtn" onclick="send()" disabled>Send</button>
            `;
            document.getElementById("addendum").innerHTML = chatroom;
        }

        // 3. 接続演出
        function startProgress() {
            var c = 0;
            var progressbar = document.getElementById("progressbar");
            var btn = document.getElementById("sendBtn");
            var input = document.getElementById("chatInput");

            function tick() {
                c++;
                if (c > 100) c = 100;
                var bar = "#".repeat(Math.floor(c / 5));
                progressbar.innerHTML = `>該当しないアクセスが確認されました。接続します。<br>${bar} ${c}%`;

                if (c < 100) {
                    setTimeout(tick, 30);
                } else {
                    progressbar.innerHTML = `>こちら、世界の外側N/A市です。ごきげんよう、内側の方。<br>${bar} 100%<br>`;
                    btn.disabled = false;
                    input.focus();

                    // --- エンターキーの設定（ここなら確実） ---
                    input.addEventListener("keydown", function(e) {
                        if (e.key === "Enter" && !e.isComposing) {
                            e.preventDefault();
                            send();
                        }
                    });

                    chat2();
                }
            }
            setTimeout(tick, 50);
        }

        function chat2() {
            var chatlog = document.getElementById("chatlog");
            chatlog.innerHTML += "<ins>Shirase:</ins>ちゃんと届いているかい？<br>";
        }

        // 4. 送信処理
        function send() {
            var input = document.getElementById("chatInput");
            var message = input.value.trim();
            if (message === "") return;

            var chatlog = document.getElementById("chatlog");
            chatlog.innerHTML += `<ins>あなた:</ins> ${message}<br>`;

            let reply = "";

            // フラグ管理
            if (message.includes("境界線")) {
                localStorage.setItem('met_boundary', 'true');
            }

            // 特殊分岐
            if (message.includes("こんに")) {
                if (localStorage.getItem('met_boundary')) {
                    reply = "やあ。境界線の向こう側を覗いた気分はどうだい？";
                } else {
                    reply = responses["こんに"] || "こんにちは。そこは昼かな？";
                }
            } 
            // 辞書チェック
            else {
                const matchedKey = Object.keys(responses).find(key => message.includes(key));
                if (matchedKey) {
                    reply = responses[matchedKey];
                }
            }

            // ランダム応答
            if (!reply) {
                var randomReplies = [
                    "君、それ、どこで聞いたんだい？知ってることが混じってる",
                    "……ごめん、その言葉は此処まで届いていないみたいだ",
                    "いい質問だ。でも答えはないよ",
                    "君がそれをどう解釈するか、見ものだ",
                    "縺ｾ縺?遲斐∴縺檎畑諢上＆繧後※縺?∪縺帙ｓ"
                ];
                reply = randomReplies[Math.floor(Math.random() * randomReplies.length)];
            }

            setTimeout(() => {
                chatlog.innerHTML += `<ins>Shirase:</ins> ${reply}<br>`;
                var obj = document.getElementById("chatbox");
                obj.scrollTop = obj.scrollHeight;
            }, 800);

            input.value = "";
            input.focus();
        }
    </script>

</body>
</html>
