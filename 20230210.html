<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>「箱」簡易接続装置</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #111; color: white; text-align: center; }
        #addendum { margin: 20px auto; width: 600px; }
        #chatbox { width: 100%; height: 300px; background: black; color: white; overflow-y: auto; padding: 10px; border: 1px solid white; text-align: left; }
        input[type="text"] { width: 80%; padding: 5px; }
        button { padding: 5px 10px; }
    </style>
</head>
<body onload="init()">

    <h1>箱</h1>
    <div id="addendum"></div>

    <script>
        let responses = {};

        // 起動時に外部JSONを読み込む
        async function init() {
            try {
                const response = await fetch('responses.json');
                responses = await response.json();
                chat(); // JSON読み込み完了後にチャット開始
            } catch (error) {
                console.error("辞書データの読み込みに失敗しました:", error);
                // 失敗時の予備
                responses = {"エラー": "データの同期に失敗したみたいだ。"};
                chat();
            }
        }

        function chat() {
            var chatroom = `
                <div id="chatbox">
                    <pre><span id="progressbar"></span><span id="chatlog"></span></pre>
                </div>
                <input type="text" id="chatInput" maxlength="30" placeholder="メッセージを入力">
                <button id="sendBtn" onclick="send()" disabled>Send</button>
            `;
            document.getElementById("addendum").innerHTML = chatroom;

            var c = 0;
            function progress() {
                c++;
                if (c > 100) c = 100;
                var bar = "#".repeat(c / 5);
                var text = `>該当しないアクセスが確認されました。接続します。<br>${bar} ${c}%`;
                document.getElementById("progressbar").innerHTML = text;

                if (c < 100) {
                    setTimeout(progress, 30);
                } else {
                    document.getElementById("progressbar").innerHTML = `>こちら、世界の外側N/A市です。ごきげんよう、内側の方。<br>${bar} 100%<br>`;
                    document.getElementById("sendBtn").disabled = false;
                    chat2();
                }
            }
            setTimeout(progress, 50);
        }

        function chat2() {
            var chatlog = document.getElementById("chatlog");
            chatlog.innerHTML += "<ins>Shirase:</ins>ちゃんと届いているかい？<br>";
        }

        function send() {
            var input = document.getElementById("chatInput");
            var message = input.value.trim();
            if (message === "") return;

            var chatlog = document.getElementById("chatlog");
            chatlog.innerHTML += `<ins>あなた:</ins> ${message}<br>`;

            // --- 判定ロジック開始 ---
            let reply = "";

            // 1. フラグ管理：特定の単語を入力したらフラグを立てる
            if (message.includes("境界線")) {
                localStorage.setItem('met_boundary', 'true');
            }

            // 2. フラグによる分岐の例：こんにちは
            if (message.includes("こんに")) {
                if (localStorage.getItem('met_boundary')) {
                    reply = "やあ。境界線の向こう側を覗いた気分はどうだい？";
                } else {
                    reply = responses["こんに"];
                }
            } 
            // 3. 通常のキーワード判定（部分一致）
            else {
                const matchedKey = Object.keys(responses).find(key => message.includes(key));
                if (matchedKey) {
                    reply = responses[matchedKey];
                }
            }

            // 4. 何もヒットしない場合のランダム応答
            if (!reply) {
                var randomReplies = [
                    "君、それ、どこで聞いたんだい？知ってることが混じってる",
                    "……ごめん、その言葉は此処まで届いていないみたいだ",
                    "いい質問だ。負の遺産かもしれないけど",
                    "君がそれをどう解釈するか、見ものだ",
                    "不確かなものに手を出しても大丈夫かい？",
                    "e78fbee59ca8e9968be799bae4b8ade381a7e38199e38082",
                    "縺ｾ縺?遲斐∴縺檎畑諢上＆繧後※縺?∪縺帙ｓ"
                ];
                reply = randomReplies[Math.floor(Math.random() * randomReplies.length)];
            }

            // 出力
            setTimeout(() => {
                chatlog.innerHTML += `<ins>Shirase:</ins> ${reply}<br>`;
                // スクロールを一番下に
                var obj = document.getElementById("chatbox");
                obj.scrollTop = obj.scrollHeight;
            }, 800);

            input.value = "";
        }
    </script>

</body>
</html>